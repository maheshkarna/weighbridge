<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta content="default-src * data: blob:; style-src *  'unsafe-inline' cdvfile://*; script-src * 'unsafe-inline' 'unsafe-eval' 'unsafe-hashes' cdvfile://* blob:; img-src * data: 'unsafe-inline'; connect-src * 'unsafe-inline';
                frame-src *; " http-equiv="Content-Security-Policy">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' data: blob:; script-src 'self' 'unsafe-eval' 'unsafe-inline' blob: ; style-src 'self' 'unsafe-eval' 'unsafe-inline' ; connect-src * 'self' 'unsafe-eval' 'unsafe-inline' ;">
  
    <link rel="apple-touch-icon" sizes="76x76" href="./css/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./css/assets/img/favicon.png">
  <title>
    Weighbridge Application
  </title>
  <!--   Fonts and icons     -->
  <!-- <link href="./css/assets/js/family.css" rel="stylesheet" /> -->

  <!-- Nucleo Icons -->
  <link href="./css/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="./css/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->


  <link href="./css/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="./css/assets/css/soft-ui-dashboard.css?v=1.0.7" rel="stylesheet" />

  <link href="./lib/fontawesome/css/all.css" rel="stylesheet">
  <link href="./lib/fontawesome/css/fontawesome.css" rel="stylesheet">
  <link href="./lib/fontawesome/css/brands.css" rel="stylesheet">
  <link href="./lib/fontawesome/css/solid.css" rel="stylesheet">

</head>

<body>


  <div class="row justify-content-end">
    <!-- <a href="creatLogins.html" class="btn btn-primary">Create logins</a>
    <a href="index2.html" class="btn btn-primary">Create Weighment</a> -->
  </div>

  <div class="container position-sticky z-index-sticky top-0">
    <div class="row">
      <div class="col-12">
        <!-- Navbar -->
       
        <nav
          class="navbar navbar-expand-lg blur blur-rounded top-0 z-index-3 shadow position-absolute my-3 py-2 start-0 end-0 mx-4">
          <div class="container-fluid pe-0">
            <a class="navbar-brand font-weight-bolder ms-lg-0 ms-3 " href="#">
              HINDUSTAN AGRO PRODUCTS LIMITED
            </a>
            <button class="navbar-toggler shadow-none ms-2" type="button" data-bs-toggle="collapse"
              data-bs-target="#navigation" aria-controls="navigation" aria-expanded="false"
              aria-label="Toggle navigation">
              <span class="navbar-toggler-icon mt-2">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </span>
            </button>
          </div>
        </nav>
        <!-- End Navbar -->
      </div>
    </div>
  </div>
  <main class="main-content  mt-0">
    <section>
      <div class="page-header min-vh-75">
        <div class="container">
          <div class="row">
            <div class="col-xl-4 col-lg-5 col-md-6 d-flex flex-column mx-auto">
              <div class="card card-plain mt-8">
                <div class="card-header pb-0 text-left bg-transparent">
                  <div>
                    <h4 id="timer" ><h4>
                  </div>
                  <h3 class="font-weight-bolder text-info text-gradient">Welcome back</h3>
                  <p class="mb-0">Enter your username and password to sign in</p>
                </div>
                <div class="card-body">
                  <form role="form">
                    <div class="mb-3">
                      <select id="user_type" name="user_type" class="form-control">
                        <option value="user">USER</option>
                        <option value="admin">ADMIN</option> 
                      </select>
                    </div>
                  
                    <div class="mb-3">
                      <input type="text" class="form-control" placeholder="Username" aria-label="Email" id="username"
                        name="username" aria-describedby="email-addon">
                    </div>
                    
                    <div class="mb-3">
                      <input type="password" class="form-control" placeholder="Password" aria-label="Password"
                        id="password"  name="password" aria-describedby="password-addon">
                    </div>
               

                    <div class="text-center">
                      <button type="button" id="loginBtn" class="btn bg-gradient-info w-100 mt-4 mb-0">Login</button>
                    </div>
                    <!-- <a href="#"  onclick="regDataAPI()" class="float-end pt-3">API</a> -->
                  </form>
                </div>

              </div>
            </div>
            <div class="col-md-6">
              <div class="oblique position-absolute top-0 h-100 d-md-block d-none me-n8">
                <div class="oblique-image bg-cover position-absolute fixed-top ms-auto h-100 z-index-0 ms-n6"
                  style="background-image:url('./css/assets/img/curved-images/curved6.jpg')"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <!-- <input type="file" name="uploadFile" id="uploadFile">
  <input type="submit" id="uploadButton" value="upload">
  <input type="text" name="testtrue" id="testtrue" value="" />
  <button type="button" class="btn btn-primary" id="triggerSerialBtn">Trigger serial</button>
  <button type="button" id="stopReading">Stop Serial</button>
  <button type="button" class="btn btn-primary" id="triggerSocketConnection">Trigger socket</button> -->
  <!-- -------- START FOOTER 3 w/ COMPANY DESCRIPTION WITH LINKS & SOCIAL ICONS & COPYRIGHT ------- -->
  <footer class="footer py-5">
    <div class="container">
      <div class="row align-items-center justify-content-lg-between">
        <div class="col-lg-6 mb-lg-0 mb-4">
          <div class="copyright text-center text-sm text-muted text-lg-start">
            Â© <script>
              document.write(new Date().getFullYear())
            </script>,
              made with 
            <a href="#" class="font-weight-bold" target="_blank">Spondias Private Limited</a>
          </div>
        </div>
        <div class="col-lg-6">
        </div>
      </div>
    </div>
   </footer>
  </div>
  <!-- use below for testing font awesome -->
  <!-- <i class="fa-solid fa-user"></i>
  <i class="fa-brands fa-github-square"></i> -->
</body>
<script src="./lib/jquery/jquery-3.6.3.min.js"></script>
<link href="./css/assets/css/toastr.css" rel="stylesheet"/>
<script src="./css/assets/js/toastr.js"></script>
<!-- <script src="./lib/bootstrap/js/bootstrap.min.js"></script> -->
<script src="./css/assets/js/core/popper.min.js"></script>
<script src="./css/assets/js/core/bootstrap.min.js"></script>
<script src="./css/assets/js/plugins/perfect-scrollbar.min.js"></script>
<script src="./css/assets/js/plugins/smooth-scrollbar.min.js"></script>
<script src="./css/assets/js/soft-ui-dashboard.min.js?v=1.0.7"></script>

<script src="./lib/videojs/video.min.js"></script>
<!-- <script src="./css/assets/js/42d5adcbca.js" crossorigin="anonymous"></script> -->
<script src="./js/database.js"></script>

<script src="./js/general.js"></script>
<script src="./js/db/dateCheckRepo.js"></script>

<script src="./js/db/customerTables.js"></script>
<script src="./js/db/taskRepository.js"></script>
<script src="./js/db/registrationRepo.js"></script>
<script src="./js/login.js"></script>
<script src="./js/serialHelper.js"></script>
<script src="./js/socket.io.js"></script>
<script>
$(document).ready(function () {

      $.when(
          app.database.tables.Registration.getData()
      ).done(function (data) { 
          if(data == null || data.lenght == 0){ 
          window.location='registrationScreen.html';
         //getKey_Temp();
          }else{
          let enckey = data[0].REGISTRATIONKEY;
          checkIsReg(enckey)   
          }
      })

    //Date time Detection
    // checkDateStatus();
});
   
//Decryption Registration Key
function checkIsReg(enckey){
      $.ajax({
      url: "http://localhost:8686/decryptString",
      type: "GET",
      cache: false,
      data: {'encregkey': enckey,'skey':'machineId_endDate' },
      success: function (decryptRegKey) {
      if(decryptRegKey !=""){
      checkMachineId(decryptRegKey);
      }
      if(decryptRegKey == ""){
        getKey_Temp();
      }
      }
  });
}

//get RegKey From Temp Folder
function getKey_Temp(){
  $.ajax({
        url: "http://localhost:8686/readFile",
        type: "GET",
        cache: false,
        data: {'skey':'machineId_endDate' },
        success: function (encryptRegKey) {

          if(encryptRegKey !=""){
              $.ajax({
                  url: "http://localhost:8686/decryptString",
                  type: "GET",
                  cache: false,
                  data: {'encregkey': encryptRegKey,'skey':'machineId_endDate' },
                  success: function (decryptRegKey) {
                  if(decryptRegKey !=""){
                  
                      checkMachineId(decryptRegKey);
                  }
                }
              });
           }else{
            window.location="expiredScreen.html"
          }
        }
       });
    }

///////////////////////////////////////////////////////////

function checkMachineId(decryptRegKey){
  // alert(decryptRegKey);
    if(decryptRegKey != "" ){  
      $.ajax({
      url: "http://localhost:8686/getMechineId", 
      type: "GET",
      cache: false,
      success: function (OrgMachineId) {
        let decMschineId = (decryptRegKey).split('.')[0];
        if( OrgMachineId == decMschineId){
        countDays(decryptRegKey)
        }else{
        console.log("Machine Id Is Not Maching")
        window.location="expiredScreen.html"
        }
      },
    });    
    }else{
      window.location="expiredScreen.html"
    }
}


function countDays(decryptRegKey){
      let regKeyDate = (decryptRegKey).split('.')[1];
      var currentDate = new Date();
      const currentISODate = currentDate.toISOString().split('T')[0];
      const isoDateString1 = currentISODate;
      // const isoDateString2 = yyyy+"-"+mm+"-"+dd;
      const isoDateString2 = regKeyDate;
      const currenDate = new Date(isoDateString1);
      const expiryDate = new Date(isoDateString2);
      if(isoDateString1 <= isoDateString2){
      const diffInMs = expiryDate - currenDate;
      const diffInDays = Math.floor(diffInMs / 86400000);
      if(diffInDays > 0 && diffInDays < 3){
      document.getElementById("timer").innerHTML = `Your Key Will Expire In ${diffInDays}  ${diffInDays == 1 ?'Day':'Days'}`;
      }else
      if(diffInDays == 0){
      const endTime = new Date();
      endTime.setHours(24, 0, 0, 0);
      const timerId = setInterval(() => {
      const remainingTime = endTime.getTime() - new Date().getTime();
      if (remainingTime < 0) {
        clearInterval(timerId);
        console.log('Timer expired');
      }else {
        const remainingHours = Math.floor(remainingTime / (60 * 60 * 1000));
        const remainingMinutes = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
        const remainingSeconds = Math.floor((remainingTime % (60 * 1000)) / 1000);
        document.getElementById("timer").innerHTML = `Your Key Will Expire In- ${remainingHours}:${remainingMinutes}:${remainingSeconds}`;
      }
      }, 1000);
      }             
    }else{
    window.location="expiredScreen.html"; 
  } 
}

////////////////////////// Date and Time Detection ///////////////////////
function checkDateStatus(){
  
  $.when(
    app.database.tables.dateChek.getDateStatus()
  ).done(function (data) {
    let currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit',second:'2-digit',hour12: false });
    let currentDate = new Date().toISOString().split('T')[0];
    let currentDateTime = currentDate+''+currentTime;
      let existingDateTime = data[0].DATE_STATUS;
    if(existingDateTime < currentDateTime) {
      app.database.tables.dateChek.updateDateStatus(currentDateTime);
      updateDateFile(currentDateTime);
    }else{
      getDatefile(currentDateTime)
    } 
  })
 }

function updateDateFile(currentDateTime){
  $.ajax({
     url: "http://localhost:8686/updateDate", 
     type: "GET",
     cache: false,
     data: {'currentDate': currentDateTime},
     success: function (OrgMachineId) {
       console.log(OrgMachineId);
       $('#registaion_key').val(OrgMachineId);
     },
   });
}

function getDatefile(currentDateTime){
  $.ajax({
    url: "http://localhost:8686/readDateFile", 
    type: "GET",
    cache: false,
   // data: {'currentDateTime': currentDateTime},
    success: function (exeDateTime) {
      if(exeDateTime !=""){
        if(exeDateTime < currentDateTime){
          app.database.tables.dateChek.updateDateStatus(currentDateTime);
          updateDateFile(currentDateTime);
          
        }else{
         alert('Local date has changed')
       window.location = "dateCheckScreen.html"
        }
      }else{
       window.location = "dateCheckScreen.html"
      alert('Local date has changed')
      }
    },
  });
}
//  setInterval(checkDateStatus, 60000);

////////////////////////// End ///////////////////////////////////////////
</script>
</html>